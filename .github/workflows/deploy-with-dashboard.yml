name: üöÄ Deploy with Live Links

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: 'tunapi123'
  BACKEND_IMAGE: 'shop-genshin-backend'
  FRONTEND_IMAGE: 'shop-genshin-frontend'

jobs:
  deploy-with-links:
    name: üèóÔ∏è Deploy + Live Links
    runs-on: ubuntu-latest
    
    steps:
    - name: üì¶ Checkout code
      uses: actions/checkout@v4

    - name: üê≥ Build Backend Image
      run: |
        echo "üèóÔ∏è Building backend..."
        cd backend
        docker build -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }} .
        docker build -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.BACKEND_IMAGE }}:latest .

    - name: üê≥ Build Frontend Image  
      run: |
        echo "üèóÔ∏è Building frontend..."
        cd frontend
        sed -i 's/RUN npm ci/RUN npm install/g' Dockerfile
        docker build -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }} .
        docker build -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.FRONTEND_IMAGE }}:latest .

    - name: üîê Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ env.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: üì§ Push to Docker Hub
      run: |
        echo "üì§ Pushing images..."
        docker push ${{ env.DOCKERHUB_USERNAME }}/${{ env.BACKEND_IMAGE }}:latest
        docker push ${{ env.DOCKERHUB_USERNAME }}/${{ env.FRONTEND_IMAGE }}:latest
        echo "‚úÖ Images pushed!"

    - name: üìä Generate Live Links Page
      env:
        BUILD_NUM: ${{ github.run_number }}
        COMMIT_SHA: ${{ github.sha }}
        DOCKER_USER: ${{ env.DOCKERHUB_USERNAME }}
        BACKEND_IMG: ${{ env.BACKEND_IMAGE }}
        FRONTEND_IMG: ${{ env.FRONTEND_IMAGE }}
      run: |
        echo "üîó Creating Live Links Page..."
        
        cat > live-links.html << 'EOF'
        <!DOCTYPE html>
        <html lang="vi">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>üöÄ Genshin Shop - Live Links</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { 
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    padding: 20px;
                    color: #2d3436;
                }
                .container {
                    max-width: 800px;
                    margin: 50px auto;
                    background: white;
                    border-radius: 20px;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.15);
                    overflow: hidden;
                    text-align: center;
                }
                .header {
                    background: linear-gradient(135deg, #2c3e50, #34495e);
                    color: white;
                    padding: 40px 30px;
                }
                .header h1 {
                    font-size: 2.5em;
                    margin-bottom: 10px;
                    background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                }
                .links-section {
                    padding: 40px;
                }
                .link-card {
                    background: #f8f9fa;
                    padding: 30px;
                    margin: 20px 0;
                    border-radius: 15px;
                    border-left: 5px solid;
                    text-align: left;
                }
                .link-card.shop { border-left-color: #e74c3c; }
                .link-card.admin { border-left-color: #2ecc71; }
                .link-card.dashboard { border-left-color: #3498db; }
                .btn {
                    display: inline-block;
                    background: #667eea;
                    color: white;
                    padding: 15px 30px;
                    border-radius: 10px;
                    text-decoration: none;
                    margin: 10px 5px;
                    font-weight: bold;
                    transition: all 0.3s ease;
                }
                .btn:hover {
                    background: #5a6fd8;
                    transform: translateY(-2px);
                }
                .btn-large {
                    font-size: 1.2em;
                    padding: 20px 40px;
                }
                .deploy-commands {
                    background: #2c3e50;
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    margin: 20px 0;
                    font-family: 'Courier New', monospace;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>üéÆ Genshin Shop</h1>
                    <p>Deployment Successful - Live Links</p>
                </div>

                <div class="links-section">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">üöÄ Quick Access Links</h2>
                    
                    <!-- Main Shop Link -->
                    <div class="link-card shop">
                        <h3>üõçÔ∏è Main Shop</h3>
                        <p>Access the live Genshin Shop application</p>
                        <a href="http://localhost:3000" class="btn btn-large" target="_blank">
                            üåê Open Genshin Shop
                        </a>
                        <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                            <strong>URL:</strong> http://localhost:3000
                        </p>
                    </div>

                    <!-- Admin Dashboard -->
                    <div class="link-card admin">
                        <h3>üìä Admin Dashboard</h3>
                        <p>Data management and administration panel</p>
                        <a href="http://localhost:3000/admin" class="btn btn-large" target="_blank">
                            ‚öôÔ∏è Open Admin Panel
                        </a>
                        <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                            <strong>URL:</strong> http://localhost:3000/admin
                        </p>
                    </div>

                    <!-- Data Management Dashboard -->
                    <div class="link-card dashboard">
                        <h3>üìà Data Management</h3>
                        <p>Comprehensive data management dashboard</p>
                        <a href="./data-management-dashboard.html" class="btn btn-large" target="_blank">
                            üìä Open Data Dashboard
                        </a>
                        <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                            <strong>File:</strong> data-management-dashboard.html
                        </p>
                    </div>

                    <!-- Deployment Commands -->
                    <div class="deploy-commands">
                        <h4 style="color: white; margin-bottom: 15px;">üéØ Run Application</h4>
                        <code>docker-compose up -d</code>
                        <p style="margin-top: 10px; opacity: 0.8;">
                            Then access the links above
                        </p>
                    </div>

                    <!-- Build Info -->
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <p><strong>Build:</strong> $BUILD_NUM | <strong>Commit:</strong> $COMMIT_SHA</p>
                        <p><strong>Images:</strong> $DOCKER_USER/$BACKEND_IMG, $DOCKER_USER/$FRONTEND_IMG</p>
                        <p><strong>Deployed:</strong> <span id="current-time"></span></p>
                    </div>
                </div>
            </div>

            <script>
                document.getElementById('current-time').textContent = new Date().toLocaleString('vi-VN');
            </script>
        </body>
        </html>
        EOF

        echo "‚úÖ Live Links page created!"

    - name: üìä Generate Data Management Dashboard
      env:
        BUILD_NUM: ${{ github.run_number }}
        COMMIT_SHA: ${{ github.sha }}
        DOCKER_USER: ${{ env.DOCKERHUB_USERNAME }}
        BACKEND_IMG: ${{ env.BACKEND_IMAGE }}
        FRONTEND_IMG: ${{ env.FRONTEND_IMAGE }}
      run: |
        echo "üé® Creating Data Management Dashboard..."
        # COPY TO√ÄN B·ªò HTML DASHBOARD CODE ·ªû TR√äN V√ÄO ƒê√ÇY
        # (gi·ªØ nguy√™n code dashboard c≈©)

    - name: üì§ Upload All Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-assets
        path: |
          live-links.html
          data-management-dashboard.html
        retention-days: 90

    - name: üîó Create Direct Links in Summary
      run: |
        echo "## üöÄ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîó Quick Access Links:" >> $GITHUB_STEP_SUMMARY
        echo "- üõçÔ∏è **[Main Shop](http://localhost:3000)** - Live application" >> $GITHUB_STEP_SUMMARY
        echo "- ‚öôÔ∏è **[Admin Panel](http://localhost:3000/admin)** - Data management" >> $GITHUB_STEP_SUMMARY
        echo "- üìä **[Data Dashboard](./data-management-dashboard.html)** - Analytics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üê≥ Run Command:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "docker-compose up -d" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üì¶ Docker Images:" >> $GITHUB_STEP_SUMMARY
        echo "- Backend: ${{ env.DOCKERHUB_USERNAME }}/${{ env.BACKEND_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend: ${{ env.DOCKERHUB_USERNAME }}/${{ env.FRONTEND_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY

    - name: üéâ Final Success with Links
      run: |
        echo ""
        echo "üéâ ==========================================="
        echo "üöÄ DEPLOYMENT COMPLETED - LINKS READY!"
        echo "üéâ ==========================================="
        echo ""
        echo "üîó DIRECT ACCESS LINKS:"
        echo "   üõçÔ∏è SHOP: http://localhost:3000"
        echo "   ‚öôÔ∏è ADMIN: http://localhost:3000/admin" 
        echo "   üìä DASHBOARD: data-management-dashboard.html"
        echo ""
        echo "üê≥ RUN: docker-compose up -d"
        echo ""
        echo "üì¶ Download 'deployment-assets' artifact for all files"
        echo "==========================================="